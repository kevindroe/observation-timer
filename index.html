<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Teaching Interaction Timer</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7fb; color: #111; }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    p { margin: 8px 0 16px; color: #333; }
    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 780px) { .grid { grid-template-columns: 1.1fr .9fr; } }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input[type="text"], input[type="date"], input[type="number"]{
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dbe8;
      background: #fff; font-size: 14px;
    }
    input[type="number"]{ max-width: 140px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 780px) { .row.two { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 780px) { .row.three { grid-template-columns: 1fr 1fr 1fr; } }

    .bigtime { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
    .time { font-variant-numeric: tabular-nums; letter-spacing: 0.5px; }
    .totalTime { font-size: 34px; font-weight: 800; }
    .sub { font-size: 12px; color: #555; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #eef1ff; color: #2a3bb7; font-weight: 600; font-size: 12px; }
    .status { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; justify-content:flex-end; }

    .timers { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    .timer {
      border: 1px solid #e3e6f2; border-radius: 14px; padding: 12px;
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
    }
    .timer.active { border-color: #2a3bb7; box-shadow: 0 0 0 3px rgba(42,59,183,.12); }
    .timer .name { font-weight: 750; }
    .timer .desc { font-size: 12px; color: #555; margin-top: 2px; }
    .timer .t { font-size: 20px; font-weight: 800; }

    button {
      border: 0; border-radius: 12px; padding: 10px 12px; font-weight: 700;
      cursor: pointer; background: #1e2330; color: #fff;
    }
    button.secondary { background: #e9ecf6; color: #111; }
    button.danger { background: #b11b2a; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    textarea {
      width: 100%; min-height: 160px; box-sizing: border-box;
      padding: 10px 12px; border-radius: 12px; border: 1px solid #d7dbe8;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: #fbfcff;
      white-space: pre;
    }
    .hint { font-size: 12px; color: #555; margin-top: 8px; }
    .footer { font-size: 12px; color: #555; margin-top: 10px; }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#f1f3fb; padding:2px 6px; border-radius:6px; border:1px solid #d7dbe8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Classroom Observation Timer</h1>
    <p>Tap a category to start timing. Starting a new category automatically stops the previous one.</p>

    <div class="grid">
      <div class="card">
        <div class="row two">
          <div>
            <label for="observer">Observer (your name)</label>
            <input id="observer" type="text" placeholder="e.g., Kevin Droe" />
          </div>
          <div>
            <label for="classId">Course / Section</label>
            <input id="classId" type="text" placeholder="e.g., Intro to Music Ed – Section 1" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px;">
          <div>
            <label for="observee">Observee (teacher / student teacher)</label>
            <input id="observee" type="text" placeholder="Name of person being observed" />
          </div>
          <div class="row two" style="gap:10px;">
            <div>
              <label for="date">Observation date</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="duration">Target duration (minutes)</label>
              <input id="duration" type="number" min="1" step="1" value="10" />
            </div>
          </div>
        </div>

        <div class="bigtime" style="margin-top: 14px;">
          <div>
            <div class="sub">Total elapsed</div>
            <div id="totalTime" class="time totalTime">00:00.0</div>
          </div>
          <div class="status">
            <span id="activePill" class="pill">Not running</span>
            <span id="targetPill" class="pill">Target: 10:00</span>
          </div>
        </div>

        <div class="timers" id="timers"></div>

        <div class="controls">
          <button id="stopBtn" class="secondary">Stop</button>
          <button id="resetBtn" class="danger">Reset</button>
          <button id="exportBtn">Export summary</button>
        </div>

        <div class="hint">
          Tip: If you accidentally hit the wrong category, just tap the correct one—time will switch instantly.<br/>
          Keyboard (optional): <span class="kbd">1</span> Student-only, <span class="kbd">2</span> Teacher modeling, <span class="kbd">3</span> Student+Teacher, <span class="kbd">4</span> Talk, <span class="kbd">Space</span> Stop.
        </div>
      </div>

      <div class="card">
        <label for="output">Export (copy/paste)</label>
        <textarea id="output" placeholder="Click “Export summary” to generate text you can paste into an LMS or Google Form."></textarea>
        <div class="controls">
          <button id="copyBtn" class="secondary">Copy to clipboard</button>
          <button id="downloadBtn" class="secondary">Download CSV</button>
        </div>
        <div class="footer">
          The CSV download is useful if students later upload to a spreadsheet. For a Google Form, copy/paste the text block.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Config ----------
  const categories = [
    {
      id: "studentOnly",
      key: "Student-only performance",
      desc: "Student is performing; teacher is not performing."
    },
    {
      id: "teacherModeling",
      key: "Teacher modeling",
      desc: "Teacher demonstrates (plays/sings) for the student."
    },
    {
      id: "bothPerform",
      key: "Student & Teacher performance",
      desc: "They perform together (duet / play along)."
    },
    {
      id: "talk",
      key: "Talk",
      desc: "Verbal instruction, discussion, feedback, questions."
    }
  ];

  // ---------- State ----------
  const state = {
    activeId: null,
    activeStart: null, // performance.now() timestamp
    msById: Object.fromEntries(categories.map(c => [c.id, 0])),
    lastTick: null,
    running: false,
    raf: null
  };

  // ---------- Elements ----------
  const timersEl = document.getElementById("timers");
  const totalTimeEl = document.getElementById("totalTime");
  const activePillEl = document.getElementById("activePill");
  const targetPillEl = document.getElementById("targetPill");
  const durationEl = document.getElementById("duration");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const exportBtn = document.getElementById("exportBtn");
  const outputEl = document.getElementById("output");
  const copyBtn = document.getElementById("copyBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  // Set today by default
  const dateEl = document.getElementById("date");
  const today = new Date();
  dateEl.valueAsDate = today;

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function formatMs(ms) {
    // mm:ss.t (tenths)
    const totalTenths = Math.floor(ms / 100);
    const tenths = totalTenths % 10;
    const totalSeconds = Math.floor(totalTenths / 10);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds / 60);
    const mm = String(m).padStart(2, "0");
    const ss = String(s).padStart(2, "0");
    return `${mm}:${ss}.${tenths}`;
  }

  function formatMsNoTenths(ms) {
    // mm:ss
    const totalSeconds = Math.round(ms / 1000);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds / 60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function getTotalMs() {
    let sum = 0;
    for (const id of Object.keys(state.msById)) sum += state.msById[id];
    return sum;
  }

  function setActivePill() {
    if (!state.activeId) {
      activePillEl.textContent = "Not running";
      return;
    }
    const cat = categories.find(c => c.id === state.activeId);
    activePillEl.textContent = `Running: ${cat ? cat.key : "Unknown"}`;
  }

  function updateTargetPill() {
    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;
    targetPillEl.textContent = `Target: ${formatMsNoTenths(targetMs)}`;
  }

  durationEl.addEventListener("change", updateTargetPill);
  updateTargetPill();

  // ---------- Rendering ----------
  function renderTimers() {
    timersEl.innerHTML = "";
    categories.forEach((c, index) => {
      const row = document.createElement("div");
      row.className = "timer";
      row.id = `row-${c.id}`;

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="name">${index + 1}. ${c.key}</div>
        <div class="desc">${c.desc}</div>
      `;

      const right = document.createElement("div");
      right.style.display = "grid";
      right.style.gap = "8px";
      right.style.justifyItems = "end";

      const t = document.createElement("div");
      t.className = "time t";
      t.id = `t-${c.id}`;
      t.textContent = formatMs(state.msById[c.id]);

      const btn = document.createElement("button");
      btn.id = `btn-${c.id}`;
      btn.textContent = "Start";
      btn.addEventListener("click", () => startCategory(c.id));

      right.appendChild(t);
      right.appendChild(btn);

      row.appendChild(left);
      row.appendChild(right);
      timersEl.appendChild(row);
    });
  }

  renderTimers();

  function paintActiveRow() {
    categories.forEach(c => {
      const row = document.getElementById(`row-${c.id}`);
      const btn = document.getElementById(`btn-${c.id}`);
      if (!row || !btn) return;

      if (state.activeId === c.id) {
        row.classList.add("active");
        btn.textContent = "Running…";
        btn.disabled = true;
      } else {
        row.classList.remove("active");
        btn.textContent = "Start";
        btn.disabled = false;
      }
    });
  }

  function updateTimesUI() {
    categories.forEach(c => {
      const t = document.getElementById(`t-${c.id}`);
      if (t) t.textContent = formatMs(state.msById[c.id]);
    });

    const totalMs = getTotalMs();
    totalTimeEl.textContent = formatMs(totalMs);

    // Optional: auto-stop when target reached
    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;
    if (totalMs >= targetMs && state.activeId) {
      // stop at the moment we hit target
      stopRunning();
    }
  }

  // ---------- Timing core ----------
  function tick(now) {
    if (!state.running) return;
    if (state.lastTick == null) state.lastTick = now;

    const dt = now - state.lastTick;
    state.lastTick = now;

    if (state.activeId) {
      state.msById[state.activeId] += dt;
    }
    updateTimesUI();
    state.raf = requestAnimationFrame(tick);
  }

  function ensureRunningLoop() {
    if (state.running) return;
    state.running = true;
    state.lastTick = null;
    state.raf = requestAnimationFrame(tick);
  }

  function startCategory(id) {
    // switching categories automatically stops overlap by design
    state.activeId = id;
    state.activeStart = performance.now();
    setActivePill();
    paintActiveRow();
    ensureRunningLoop();
  }

  function stopRunning() {
    state.activeId = null;
    state.activeStart = null;
    setActivePill();
    paintActiveRow();

    // keep loop running? we can stop loop to save CPU
    state.running = false;
    state.lastTick = null;
    if (state.raf) cancelAnimationFrame(state.raf);
    state.raf = null;
    updateTimesUI();
  }

  stopBtn.addEventListener("click", stopRunning);

  resetBtn.addEventListener("click", () => {
    stopRunning();
    for (const k of Object.keys(state.msById)) state.msById[k] = 0;
    updateTimesUI();
    outputEl.value = "";
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "textarea") return; // don't hijack typing

    if (e.code === "Space") { e.preventDefault(); stopRunning(); return; }
    if (e.key === "1") startCategory("studentOnly");
    if (e.key === "2") startCategory("teacherModeling");
    if (e.key === "3") startCategory("bothPerform");
    if (e.key === "4") startCategory("talk");
  });

  // ---------- Export ----------
  function roundToNearestSecond(ms) {
    return Math.round(ms / 1000) * 1000;
  }

  function msToPercent(ms, totalMs) {
    if (totalMs <= 0) return 0;
    return (ms / totalMs) * 100;
  }

  function exportSummary() {
    // Make sure we aren't "in between" frames; stop to freeze numbers if running
    // (optional, but makes results stable for copying)
    if (state.activeId) stopRunning();

    const observer = document.getElementById("observer").value.trim();
    const classId = document.getElementById("classId").value.trim();
    const observee = document.getElementById("observee").value.trim();
    const dateVal = dateEl.value;

    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;

    const rawTotalMs = getTotalMs();
    const totalMs = roundToNearestSecond(rawTotalMs);

    const lines = [];
    lines.push("CLASSROOM OBSERVATION TIMING SUMMARY");
    lines.push("-----------------------------------");
    if (observer) lines.push(`Observer: ${observer}`);
    if (classId) lines.push(`Course/Section: ${classId}`);
    if (observee) lines.push(`Observee: ${observee}`);
    if (dateVal) lines.push(`Date: ${dateVal}`);
    lines.push(`Target duration: ${formatMsNoTenths(targetMs)}`);
    lines.push(`Total observed:  ${formatMsNoTenths(totalMs)}`);
    lines.push("");

    // Category breakdown
    lines.push("Breakdown (mm:ss | % of total):");
    categories.forEach(c => {
      const ms = roundToNearestSecond(state.msById[c.id]);
      const pct = msToPercent(ms, totalMs);
      lines.push(`- ${c.key}: ${formatMsNoTenths(ms)} | ${pct.toFixed(1)}%`);
    });

    // Copy-friendly single-line version for a Google Form short answer field
    lines.push("");
    lines.push("Copy/paste one-line version:");
    const oneLineParts = [];
    if (observee) oneLineParts.push(`Observee=${observee}`);
    if (dateVal) oneLineParts.push(`Date=${dateVal}`);
    oneLineParts.push(`Total=${formatMsNoTenths(totalMs)}`);
    categories.forEach(c => {
      const ms = roundToNearestSecond(state.msById[c.id]);
      oneLineParts.push(`${c.key}=${formatMsNoTenths(ms)}`);
    });
    lines.push(oneLineParts.join(" | "));

    outputEl.value = lines.join("\n");
  }

  exportBtn.addEventListener("click", exportSummary);

  copyBtn.addEventListener("click", async () => {
    const text = outputEl.value.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy to clipboard"), 900);
    } catch {
      // Fallback: select text
      outputEl.focus();
      outputEl.select();
      document.execCommand("copy");
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy to clipboard"), 900);
    }
  });

  function downloadCSV() {
    // stop to freeze
    if (state.activeId) stopRunning();

    const observer = document.getElementById("observer").value.trim();
    const classId = document.getElementById("classId").value.trim();
    const observee = document.getElementById("observee").value.trim();
    const dateVal = dateEl.value;

    const totalMs = roundToNearestSecond(getTotalMs());

    // CSV columns: observer, course, observee, date, total, each category seconds
    const headers = [
      "observer",
      "course_section",
      "observee",
      "date",
      "total_mmss",
      "student_only_mmss",
      "teacher_modeling_mmss",
      "student_teacher_mmss",
      "talk_mmss"
    ];

    const values = [
      observer,
      classId,
      observee,
      dateVal,
      formatMsNoTenths(totalMs),
      formatMsNoTenths(roundToNearestSecond(state.msById["studentOnly"])),
      formatMsNoTenths(roundToNearestSecond(state.msById["teacherModeling"])),
      formatMsNoTenths(roundToNearestSecond(state.msById["bothPerform"])),
      formatMsNoTenths(roundToNearestSecond(state.msById["talk"]))
    ];

    const esc = (s) => {
      const str = (s ?? "").toString();
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
      return str;
    };

    const csv = `${headers.join(",")}\n${values.map(esc).join(",")}\n`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const safeName = (observee || "observation").replace(/[^a-z0-9]+/gi, "_").replace(/^_+|_+$/g, "");
    a.href = url;
    a.download = `${safeName || "observation"}_timing.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", downloadCSV);

  // initial paint
  setActivePill();
  paintActiveRow();
  updateTimesUI();
})();
</script>
</body>
</html>
